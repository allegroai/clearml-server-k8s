{{- range .Values.agentGroups }}
---
{{ if .trainsConfig }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .name }}-conf
data:
  trains.conf: {{ .trainsConfig | b64enc }}
---
{{ end }}
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/name: {{ .name }}
    app.kubernetes.io/instance: {{ $.Release.Name }}
    app.kubernetes.io/part-of: trains-server
    app.kubernetes.io/managed-by: {{ $.Release.Service }}
    helm.sh/chart: {{ $.Chart.Name }}-{{ $.Chart.Version | replace "+" "_" }}
    allegro.ai/node-type: trains-agent
  name: {{ .name }}
  namespace: {{ $.Values.trains.namespace }}
spec:
  replicas: {{ .numberOfTrainsAgents }}
  selector:
    matchLabels:
          app.kubernetes.io/name: {{ .name }}
          app.kubernetes.io/instance: {{ $.Release.Name }}
          app.kubernetes.io/part-of: trains-server
          app.kubernetes.io/managed-by: {{ $.Release.Service }}
  minReadySeconds: 20
  progressDeadlineSeconds: 30
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
          app.kubernetes.io/name: {{ .name }}
          app.kubernetes.io/instance: {{ $.Release.Name }}
          app.kubernetes.io/part-of: trains-server
          app.kubernetes.io/managed-by: {{ $.Release.Service }}
          helm.sh/chart: {{ $.Chart.Name }}-{{ $.Chart.Version | replace "+" "_" }}
          allegro.ai/node-type: trains-agent
    spec:
      containers:
      - image: nvidia/cuda
        name: trains-agent
        securityContext:
          privileged: true
        resources:
          limits:
            nvidia.com/gpu:
              {{ .nvidiaGpusPerAgent }}
        volumeMounts:
          {{if .dockerMode}}
          - name: dockersock
            mountPath: "/var/run/docker.sock"
          {{ end}}
          {{ if .trainsConfig }}
          - name: agent-trains-conf-volume
            mountPath: "/root/trains.conf"
            subPath: trains.conf
            readOnly: true
          {{ end}}
          - name: agent-data
            mountPath: /root/.trains
        env:
          - name: TRAINS_API_HOST
            value: {{ .trainsApiHost}}
          - name: TRAINS_WEB_HOST
            value: {{ .trainsWebHost}}
          - name: TRAINS_FILES_HOST
            value: {{ .trainsFilesHost}}
          - name: TRAINS_AGENT_GIT_USER
            value: {{ .trainsGitUser}}
          - name: TRAINS_AGENT_GIT_PASS
            value: {{ .trainsGitPassword}}
          - name: TRAINS_API_ACCESS_KEY
            value: {{ .trainsAccessKey}}
          - name: TRAINS_API_SECRET_KEY
            value: {{ .trainsSecretKey}}
          - name: AWS_ACCESS_KEY_ID
            value: {{ .awsAccessKeyId}}
          - name: AWS_SECRET_ACCESS_KEY
            value: {{ .awsSecretAccessKey}}
          - name: AWS_DEFAULT_REGION
            value: {{ .awsDefaultRegion}}
          - name: AZURE_STORAGE_ACCOUNT
            value: {{ .azureStorageAccount}}
          - name: AZURE_STORAGE_KEY
            value: {{ .azureStorageKey}}
        command:
          - /bin/sh
          - -c
          - "apt-get update ;
             apt-get install -y curl python3-pip git;
             curl -sSL https://get.docker.com/ | sh ;
             python3 -m pip install -U pip ;
             python3 -m pip install trains-agent{{ .agentVersion}} ;
             {{if .dockerMode}}TRAINS_DOCKER_SKIP_GPUS_FLAG=1 TRAINS_AGENT_K8S_HOST_MOUNT=/root/.trains:/root/.trains trains-agent daemon --docker {{ .defaultBaseDocker}} --force-current-version --queue {{ .queues}}"
             {{ else}}TRAINS_AGENT_K8S_HOST_MOUNT=/root/.trains:/root/.trains trains-agent daemon --queue {{ .queues}}"{{ end}}
      volumes:
      {{if .dockerMode}}
      - name: dockersock
        hostPath:
          path: /var/run/docker.sock
      {{ end}}
      {{ if .trainsConfig }}
      - name: agent-trains-conf-volume
        secret:
          secretName: {{ .name }}-conf
          items:
          - key: trains.conf
            path: trains.conf
      {{ end }}
      - name: agent-data
        hostPath:
          path: /root/.trains/
      restartPolicy: Always
{{- end }}
